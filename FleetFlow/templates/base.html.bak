{% load static auth_extras %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}FleetFlow{% endblock %} — Fleet Management</title>
    <meta name="description" content="FleetFlow — Enterprise Fleet Management System">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="{% static 'css/main.css' %}" rel="stylesheet">
</head>

<body>

    {% if user.is_authenticated %}
    <!-- ====== AUTHENTICATED LAYOUT ====== -->

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <i class="bi bi-truck-front-fill me-2 brand-icon"></i>
            <span class="brand-text">FleetFlow</span>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section-label">Overview</div>
            <a href="{% url 'dashboard' %}" class="nav-link {% if request.path|is_in:'/dashboard/' %}active{% endif %}">
                <i class="bi bi-grid-fill"></i><span>Dashboard</span>
            </a>

            {% if user|has_any_role:"MANAGER,DISPATCHER" %}
            <div class="nav-section-label mt-2">Operations</div>
            <a href="{% url 'vehicle-list' %}" class="nav-link {% if '/vehicles/' in request.path %}active{% endif %}">
                <i class="bi bi-truck"></i><span>Vehicles</span>
            </a>
            <a href="{% url 'trip-list' %}" class="nav-link {% if '/trips/' in request.path %}active{% endif %}">
                <i class="bi bi-map"></i><span>Trips</span>
            </a>
            {% endif %}

            {% if user|has_any_role:"MANAGER,SAFETY" %}
            <a href="{% url 'driver-list' %}" class="nav-link {% if '/drivers/' in request.path %}active{% endif %}">
                <i class="bi bi-person-badge"></i><span>Drivers</span>
            </a>
            {% endif %}

            {% if user|has_any_role:"MANAGER" %}
            <div class="nav-section-label mt-2">Fleet Ops</div>
            <a href="{% url 'maintenance-list' %}"
                class="nav-link {% if '/maintenance/' in request.path %}active{% endif %}">
                <i class="bi bi-tools"></i><span>Maintenance</span>
            </a>
            {% endif %}

            {% if user|has_any_role:"MANAGER,DISPATCHER,FINANCE" %}
            <a href="{% url 'expense-list' %}" class="nav-link {% if '/expenses/' in request.path %}active{% endif %}">
                <i class="bi bi-cash-stack"></i><span>Expenses</span>
            </a>
            {% endif %}

            {% if user|has_any_role:"MANAGER,FINANCE" %}
            <div class="nav-section-label mt-2">Intelligence</div>
            <a href="{% url 'analytics' %}" class="nav-link {% if '/analytics/' in request.path %}active{% endif %}">
                <i class="bi bi-bar-chart-line-fill"></i><span>Analytics</span>
            </a>
            {% endif %}

            <div class="nav-section-label mt-2">Account</div>
            <a href="{% url 'profile' %}" class="nav-link {% if request.path|is_in:'/profile/' %}active{% endif %}">
                <i class="bi bi-person-circle"></i><span>Profile</span>
            </a>
            <form method="post" action="{% url 'logout' %}" style="margin:0;">
                {% csrf_token %}
                <button type="submit" class="nav-link nav-link-danger w-100 border-0 bg-transparent text-start">
                    <i class="bi bi-box-arrow-left"></i><span>Logout</span>
                </button>
            </form>
        </nav>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content" id="main-content">
        <div class="topbar">
            <button class="btn btn-icon sidebar-toggle" id="sidebarToggle">
                <i class="bi bi-list fs-4"></i>
            </button>
            <div class="topbar-right">
                <span class="badge role-badge me-3">
                    <i class="bi bi-shield-check me-1"></i>{{ user.get_role_display }}
                </span>
                <span class="topbar-user">
                    <i class="bi bi-person-circle me-1"></i>{{ user.username }}
                </span>
            </div>
        </div>

        <div class="content-wrapper">
            {% if messages %}
            <div class="messages-container">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% block content %}{% endblock %}
        </div>
    </div>

    {% else %}
    <!-- ====== UNAUTHENTICATED LAYOUT ====== -->
    <div class="auth-wrapper">
        {% if messages %}
        <div class="messages-container position-fixed top-0 start-50 translate-middle-x pt-3"
            style="z-index:9999; max-width:480px; width:100%; padding:0 16px;">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% block auth_content %}{% endblock %}
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
            });
        }
        document.querySelectorAll('.alert').forEach(alert => {
            setTimeout(() => {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                if (bsAlert) bsAlert.close();
            }, 5000);
        });
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>