{% extends "base.html" %}
{% load auth_extras %}
{% block title %}Drivers{% endblock %}
{% block content %}
<div class="page-header d-flex justify-content-between align-items-start">
<div>
<h1 class="page-title"><i class="bi bi-person-badge me-2 text-primary"></i>Drivers</h1>
<p class="page-subtitle">Driver roster and license management</p>
</div>
{% if user.is_safety %}
<a href="{% url 'driver-create' %}" class="btn btn-primary">
<i class="bi bi-plus-lg me-1"></i>Add Driver
</a>
{% endif %}
</div>
<form method="get" id="filterForm">
<div class="adv-toolbar card mb-4">
<div class="card-body py-2 px-3">
<div class="d-flex flex-wrap align-items-center gap-2">
<div class="search-wrap">
<i class="bi bi-search search-icon"></i>
<input type="text" name="q" class="form-control search-input"
placeholder="Search name, license..." value="{{ q }}" oninput="delaySubmit(this)">
{% if q %}
<button type="button" class="clear-btn" onclick="clearField('q')">
<i class="bi bi-x"></i>
</button>
{% endif %}
</div>
<div class="separator"></div>
<div class="filter-pill">
<i class="bi bi-circle-half text-secondary me-1"></i>
<select name="status" class="filter-select" onchange="filterForm.submit()">
<option value="">All Statuses</option>
{% for val, label in duty_choices %}
<option value="{{ val }}"
{% if selected_status|is_equal:val %}
selected
{% endif %}>
{{ label }}
</option>
{% endfor %}
</select>
</div>
<div class="separator"></div>
<div class="filter-pill">
<i class="bi bi-arrow-down-up text-secondary me-1"></i>
<select name="sort" class="filter-select" onchange="filterForm.submit()">
<option value="user__username"
{% if selected_sort|is_equal:"user__username" or not selected_sort %}
selected
{% endif %}>
Username A-Z
</option>
<option value="-safety_score"
{% if selected_sort|is_equal:"-safety_score" %}
selected
{% endif %}>
Score (High-Low)
</option>
<option value="safety_score"
{% if selected_sort|is_equal:"safety_score" %}
selected
{% endif %}>
Score (Low-High)
</option>
<option value="license_expiry"
{% if selected_sort|is_equal:"license_expiry" %}
selected
{% endif %}>
Expiry (Soonest)
</option>
<option value="-license_expiry"
{% if selected_sort|is_equal:"-license_expiry" %}
selected
{% endif %}>
Expiry (Latest)
</option>
<option value="-created_at"
{% if selected_sort|is_equal:"-created_at" %}
selected
{% endif %}>
Newly Joined
</option>
</select>
</div>
{% if q or selected_status or selected_sort %}
<a href="{% url 'driver-list' %}" class="btn btn-sm btn-outline-danger ms-auto">
<i class="bi bi-x-circle me-1"></i>Clear All
</a>
{% endif %}
</div>
</div>
</div>
</form>
<div class="d-flex justify-content-between align-items-center mb-3">
<p class="text-secondary mb-0" style="font-size:.85rem;">
Showing <strong>{{ page_obj.start_index }}</strong>-<strong>{{ page_obj.end_index }}</strong> of <strong>{{ page_obj.paginator.count }}</strong> drivers
</p>
</div>
<div class="card">
{% if drivers %}
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>Driver</th>
<th>License No.</th>
<th>Expiry</th>
<th>Safety Score</th>
<th>Duty Status</th>
<th>Phone</th>
{% if user.is_safety %}<th>Actions</th>{% endif %}
</tr>
</thead>
<tbody>
{% for d in drivers %}
<tr>
<td>
<div class="fw-600">{{ d.user.get_full_name|default:d.user.username }}</div>
<div class="text-secondary small">@{{ d.user.username }}</div>
</td>
<td><code>{{ d.license_number }}</code></td>
<td>
{% if d.is_license_valid %}
<span class="text-success">{{ d.license_expiry|date:"d M Y" }}</span>
{% else %}
<span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>EXPIRED {{ d.license_expiry|date:"d M Y" }}</span>
{% endif %}
</td>
<td>
<div class="d-flex align-items-center gap-2">
<div class="progress flex-grow-1" style="height:6px;max-width:80px;">
<div class="progress-bar bg-{{ d.safety_badge_color }}" style="width:{{ d.safety_score }}%"></div>
</div>
<span class="badge bg-{{ d.safety_badge_color }}">{{ d.safety_score }}</span>
</div>
</td>
<td><span class="status-badge status-{{ d.duty_status|lower }}">{{ d.get_duty_status_display }}</span></td>
<td>{{ d.phone }}</td>
{% if user.is_safety %}
<td>
<div class="table-actions">
<a href="{% url 'driver-edit' d.pk %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
<a href="{% url 'driver-delete' d.pk %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
</div>
</td>
{% endif %}
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty-state"><i class="bi bi-person-badge"></i>
<p>No drivers found.</p>
</div>
{% endif %}
</div>
{% if page_obj.paginator.num_pages > 1 %}
<nav class="d-flex justify-content-center mt-4">
<ul class="pagination">
{% if page_obj.has_previous %}
<li class="page-item">
<a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&status={{ selected_status }}&sort={{ selected_sort }}">Prev</a>
</li>
{% endif %}
{% for num in page_obj.paginator.page_range %}
<li class="page-item
{% if page_obj.number|is_equal:num %}
active
{% endif %}">
<a class="page-link" href="?page={{ num }}&q={{ q }}&status={{ selected_status }}&sort={{ selected_sort }}">{{ num }}</a>
</li>
{% endfor %}
{% if page_obj.has_next %}
<li class="page-item">
<a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&status={{ selected_status }}&sort={{ selected_sort }}">Next</a>
</li>
{% endif %}
</ul>
</nav>
{% endif %}
<script>
function delaySubmit(input) {
clearTimeout(input.dataset.timer);
input.dataset.timer = setTimeout(() => {
input.form.submit();
}, 500);
}
function clearField(name) {
document.getElementsByName(name)[0].value = '';
document.getElementById('filterForm').submit();
}
</script>
{% endblock %}
